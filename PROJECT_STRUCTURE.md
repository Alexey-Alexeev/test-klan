## Структура проекта и работа холста

Этот документ описывает структуру проекта, роли основных модулей и подробно объясняет, как устроен холст (canvas): панорамирование, масштабирование, сетка/линейки, добавление/перемещение/изменение размера элементов (виджетов) и сохранение истории изменений.

### Обзор директорий
- `src/components/builder/`
  - `Canvas.tsx`: контейнер холста. Отвечает за размеры, зум, панорамирование, дроп новых виджетов, отображение сетки и линеек.
  - `WidgetRenderer.tsx`: отрисовка виджетов на холсте, выбор, перетаскивание, базовое редактирование содержимого.
  - `SelectionBox.tsx`: рамка выделения с хэндлами для изменения размера выбранного виджета.
  - `Ruler.tsx`: линейки по краям холста.
  - `Guides.tsx`: направляющие для выравнивания при перемещении.
  - `Toolbar.tsx`, `PropertiesPanel.tsx`: панель инструментов и свойства выбранного виджета.
- `src/features/canvas/canvasSlice.ts`: Redux-слайс состояния холста и виджетов (позиции, размеры, выделение, сетка, зум, пан). Все операции над виджетами фиксируются экшенами.
- `src/middleware/historyMiddleware.ts`: промежуточный слой, сохраняющий снимки состояния холста в историю после значимых действий.
- `src/components/widgets/*`: конкретные реализации виджетов (кнопка, текст, карточка и т.д.).
- Прочее:
  - `src/store/`: инициализация Redux-хранилища и хуки `useAppDispatch`/`useAppSelector`.
  - `src/pages/`, `src/tabs/`: навигационные страницы/вкладки (Конструктор, Шаблоны и т.д.).
  - `src/lib/widgetDefaults.ts`: фабрика для создания дефолтного виджета по типу.
  - `src/types/`: типы `CanvasState`, `IWidget`, `IPosition`, `ISize` и пр.

---

### Ключевые сущности состояния (Redux)
- `widgets: IWidget[]`: список виджетов на холсте (позиция, размер, z-index, стиль, пропсы).
- `selectedWidgetId`, `selectedWidgetIds`: текущее одиночное/множественное выделение.
- `canvasSize`: логические размеры холста.
- `gridSnap`, `snapSize`: привязка к сетке и шаг привязки.
- `zoom`, `panOffset`: масштаб и сдвиг холста.
- `showRulers`, `showGrid`, `gridSize`: линейки, сетка и её шаг.
- Дополнительно: `isMultiSelecting`, `selectionBox`, группировка и упорядочивание по Z.

Основные экшены для движения/размеров:
- `updateWidgetPosition({ id, position })`: перемещение виджета.
- `updateWidgetSize({ id, size })`: изменение размеров.
- Сервисные: `addWidget`, `deleteWidget`, `duplicateWidget`, `bringToFront`, `sendToBack`, `setZoom`, `setPanOffset`, `toggleGridSnap`, `setGridSize`, `resetView` и др.

История: `historyMiddleware` перехватывает важные экшены (`canvas/updateWidgetPosition`, `canvas/updateWidgetSize`, `canvas/addWidget`, и т.д.) и пушит снимок `canvas` в `historySlice` для Undo/Redo.

---

## Как устроен холст

### 1) Панорамирование (pan)
- В `Canvas.tsx` при нажатии средней кнопкой мыши или `Ctrl + ЛКМ` включается режим панорамирования.
- На `mousemove` вычисляется дельта и через `setPanOffset` обновляется смещение холста.
- В стилях контейнера холста применяется `transform: translate(panOffset.x, panOffset.y)`.

### 2) Масштабирование (zoom)
- Обрабатывается колесо мыши с зажатым Ctrl. `deltaY` изменяет `zoom` в разумных пределах (например 0.1–3 в UI, 0.25–2 в слайсе).
- Размеры холста в пикселях умножаются на `zoom`, рисунок сетки также учитывает масштаб.

### 3) Сетка и линейки
- Сетка рисуется фоном холста с шагом `gridSize * zoom`; позиция сетки синхронизирована с `panOffset`.
- Линейки (`Ruler`) показываются по краям, учитывая `zoom` и `panOffset`.
- Привязка к сетке (`gridSnap`) округляет координаты и размеры к кратным `snapSize`.

### 4) Добавление виджетов (Drag & Drop)
- DnD на холст (`onDrop` в `Canvas.tsx`): координаты курсора преобразуются в координаты холста с учётом `zoom` и `panOffset`.
- Если включён `gridSnap`, позиция притягивается к шагу `snapSize`.
- Через `createDefaultWidget(type, position)` создаётся виджет и диспатчится `addWidget`.

---

## Перемещение, выравнивание и изменение размера элементов

### Перемещение (drag)
- Каждый виджет обёрнут в `react-draggable` в `WidgetRenderer.tsx`.
- Обработчик `onDrag`:
  - Берёт текущие `data.x/y` и применяет выравнивание относительно других виджетов и границ холста (см. `snapToAlignment`).
  - При включённой привязке к сетке округляет координаты к `snapSize`.
  - Отправляет `updateWidgetPosition({ id, position })` в `canvasSlice`.
- Ограничения `bounds="parent"` не дают выйти за пределы области холста.

### Выравнивание (guides + авто-магниты)
- Функция `snapToAlignment` сравнивает текущие края и центры виджета с другими виджетами и с холстом с порогом (например, 10px). При близости — подхватывает координату.
- Компонент `Guides` визуально показывает направляющие, совпадающие с возможными линиями выравнивания.

### Изменение размера (resize)
- При выделении виджета поверх него рисуется `SelectionBox` с 8 хэндлами (углы и стороны).
- При перетаскивании хэндла вычисляются новые `size` и при необходимости новая `position` (для западных/северных хэндлов, где якорь меняется).
- Если включён `gridSnap`, размеры и позиция округляются к `snapSize`.
- В итоге диспатчатся `updateWidgetSize({ id, size })` и, если менялась, `updateWidgetPosition({ id, position })`.

### Выбор, удаление, редактирование
- Щелчок по виджету — `selectWidget(id)`. Щелчок по пустому месту холста — снятие выделения.
- `Delete` на выделенном виджете — `deleteWidget(id)`.
- Двойной клик по поддерживаемым виджетам (кнопка/текст/бейдж) — инлайн-редактирование текста с `Enter`/`Escape` для сохранения/отмены, экшен `updateWidget`.

---

## Роли основных компонентов
- `Canvas.tsx`: слой взаимодействий холста — зум, пан, DnD добавление, отрисовка сетки/линеек/руководящих линий и всех виджетов.
- `WidgetRenderer.tsx`: обёртка для каждого виджета — выбор, перетаскивание, авто-выравнивание, удаление, инлайн-редактирование текста, показ `SelectionBox`.
- `SelectionBox.tsx`: изменение размеров выделенного элемента через хэндлы, с учётом ограничений и привязки к сетке.
- `Guides.tsx`: расчёт/отрисовка направляющих при перемещении для точного выравнивания.
- `Ruler.tsx`: визуальные линейки, синхронизированные с текущим масштабом и панорамированием.
- `canvasSlice.ts`: единый источник правды (Redux) по всему, что касается холста и виджетов; экшены для любых модификаций.
- `historyMiddleware.ts`: автоматическое сохранение снапшотов состояния после значимых экшенов для Undo/Redo.

---

## Быстрые ответы на частые вопросы
- Как «потянуть» холст? — Средняя кнопка мыши или `Ctrl + ЛКМ`, двигайте мышь.
- Как приблизить/отдалить? — Колесо мыши с зажатым `Ctrl`.
- Как выровнять элементы? — Подведите к краю/центру другого элемента или холста; сработает магнит и появятся направляющие. Для точной сетки включите `gridSnap`.
- Как изменить размер? — Выделите элемент и потяните за маркеры `SelectionBox`.
- Как добавить элемент? — Перетащите из списка виджетов на холст (D&D).


